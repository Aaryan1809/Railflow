<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Section Controller Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a1022;
            --bg-card: #1a2234;
            --bg-card-hover: #2a3348;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --accent-blue: #4f8df9;
            --accent-green: #10b981;
            --accent-red: #f43f5e;
            --accent-yellow: #fbbf24;
            --accent-purple: #a855f7;
            --accent-teal: #14b8a6;
            --shadow: 0 8px 16px -2px rgba(0, 0, 0, 0.3), 0 4px 8px -2px rgba(0, 0, 0, 0.2);
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
            --sidebar-width: 320px;
            --transition: all 0.3s ease;
            --gradient-blue: linear-gradient(135deg, #4f8df9, #3b82f6);
            --gradient-green: linear-gradient(135deg, #10b981, #059669);
            --gradient-red: linear-gradient(135deg, #f43f5e, #e11d48);
            --gradient-yellow: linear-gradient(135deg, #fbbf24, #f59e0b);
            --gradient-purple: linear-gradient(135deg, #a855f7, #9333ea);
            --gradient-dark: linear-gradient(135deg, #1a2234, #0f172a);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }

        button {
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            background-color: var(--accent-blue);
            color: white;
            transition: var(--transition);
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        input, select {
            font-family: 'Inter', sans-serif;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--text-secondary);
            background-color: var(--bg-card);
            color: var(--text-primary);
            width: 100%;
            margin-bottom: 12px;
        }

        /* Layout Styles */
        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-card);
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .sidebar-title {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--text-secondary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .action-buttons button {
            flex: 1;
        }

        .btn-simulate {
            background-color: var(--accent-green);
        }

        .btn-clear {
            background-color: var(--accent-red);
        }

        .btn-whatif {
            background-color: var(--accent-purple);
        }

        .train-list {
            margin-top: 24px;
        }

        .train-list h3 {
            margin-bottom: 16px;
        }

        .train-card {
            background: var(--gradient-dark);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-soft);
            cursor: grab;
            transition: var(--transition);
            border-left: 4px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .train-card.dragging {
            cursor: grabbing;
            opacity: 0.8;
            transform: scale(1.02);
            z-index: 100;
        }

        .train-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, rgba(255,255,255,0.05), transparent);
            opacity: 0;
            transition: var(--transition);
        }

        .train-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .train-card:hover::before {
            opacity: 1;
        }

        .train-card.selected {
            border-left: 4px solid var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(79, 141, 249, 0.3), var(--shadow);
        }
        
        .train-card.express {
            border-left: 4px solid var(--accent-red);
            background: linear-gradient(145deg, #1a2234, #1e1a20);
        }
        
        .train-card.passenger {
            border-left: 4px solid var(--accent-blue);
            background: linear-gradient(145deg, #1a2234, #1a2030);
        }
        
        .train-card.freight {
            border-left: 4px solid var(--accent-green);
            background: linear-gradient(145deg, #1a2234, #1a2420);
        }
        
        .train-card-drag-handle {
            position: absolute;
            right: 10px;
            top: 10px;
            width: 12px;
            height: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }
        
        .train-card:hover .train-card-drag-handle {
            opacity: 1;
        }
        
        .drag-handle-line {
            height: 2px;
            background-color: var(--text-secondary);
            border-radius: 1px;
        }
        
        /* Search and Filter Styles */
        .search-input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--text-secondary);
            background-color: var(--bg-card);
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .filter-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .filter-options input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .train-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .train-number {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .train-details {
            display: flex;
            justify-content: space-between;
        }

        .train-type, .train-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .priority-chip {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .priority-high {
            background-color: var(--accent-yellow);
            color: #000;
        }

        .priority-medium {
            background-color: var(--accent-blue);
        }

        .priority-low {
            background-color: var(--accent-purple);
        }

        /* Main Area Styles */
        .main-area {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .section-name {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .datetime {
            color: var(--text-secondary);
        }

        .top-bar-actions {
            display: flex;
            gap: 12px;
        }

        .visualization {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            height: 350px;
            position: relative;
            overflow: hidden;
        }
        
        .visualization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .visualization-controls {
            display: flex;
            gap: 8px;
        }
        
        .visualization-controls button {
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-card-hover);
            color: var(--text-primary);
            font-size: 16px;
            border-radius: 6px;
        }

        .track-diagram {
            width: 100%;
            height: 250px;
            transition: transform 0.3s ease;
        }
        
        .track-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .legend-color.express {
            background-color: var(--accent-red);
        }
        
        .legend-color.passenger {
            background-color: var(--accent-blue);
        }
        
        .legend-color.freight {
            background-color: var(--accent-green);
        }

        .station {
            fill: var(--bg-card-hover);
            stroke: var(--text-secondary);
            stroke-width: 2;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.3));
        }
        
        .station-inner {
            fill: var(--accent-blue);
            stroke: var(--text-secondary);
            stroke-width: 1;
        }
        
        .junction-outer {
            fill: var(--bg-card-hover);
            stroke: var(--text-secondary);
            stroke-width: 2;
        }
        
        .junction-line {
            stroke: var(--text-secondary);
            stroke-width: 1.5;
        }

        .station-label {
            fill: var(--text-primary);
            font-size: 12px;
            text-anchor: middle;
            font-weight: 500;
        }

        .track {
            stroke: var(--text-secondary);
            stroke-width: 4;
            stroke-linecap: round;
        }
        
        .track-secondary {
            stroke: var(--text-secondary);
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            opacity: 0.7;
        }

        .train {
            position: absolute;
            width: 40px;
            height: 20px;
            border-radius: 6px;
            transition: left 5s linear, top 0.5s ease, transform 0.3s ease;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            transform-origin: center;
        }
        
        .train:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            z-index: 20;
        }
        
        .train.selected {
            outline: 2px solid white;
            outline-offset: 2px;
        }
        
        /* Train status animations */
        .train-running {
            animation: trainRunning 2s infinite;
        }
        
        .train-waiting {
            animation: trainWaiting 2s infinite;
        }
        
        .train-halted {
            opacity: 0.7;
        }
        
        @keyframes trainRunning {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(3px); }
        }
        
        @keyframes trainWaiting {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .train-express {
            background: var(--gradient-red);
        }

        .train-passenger {
            background: var(--gradient-blue);
        }

        .train-freight {
            background: var(--gradient-green);
        }
        
        .train::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            right: 4px;
            top: 7px;
        }

        .panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .panel {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .panel-title {
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--text-secondary);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .kpi-card {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-card-hover));
            border-radius: var(--border-radius);
            padding: 16px;
            text-align: center;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 8px 0;
        }

        .kpi-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .recommendation-card {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-card-hover));
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .recommendation-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-accept {
            background-color: var(--accent-green);
        }

        .btn-override {
            background-color: var(--accent-red);
        }

        .log-entry {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--bg-card-hover);
        }

        .log-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
            min-width: 60px;
        }

        .log-message {
            flex: 1;
        }

        .train-popup {
            position: absolute;
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--shadow);
            z-index: 100;
            min-width: 250px;
            display: none;
        }

        .train-popup h3 {
            margin-bottom: 12px;
            border-bottom: 1px solid var(--text-secondary);
            padding-bottom: 8px;
        }

        .train-popup-details {
            margin-bottom: 16px;
        }

        .train-popup-details p {
            margin-bottom: 8px;
        }

        .close-popup {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }
            .main-area {
                margin-left: 280px;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                overflow-y: visible;
            }
            .main-area {
                margin-left: 0;
            }
            .panels {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1 class="sidebar-title">Section Controller Dashboard</h1>
            
            <!-- Input Form -->
            <div class="form-group">
                <h3>Add Train</h3>
                <label for="train-number">Train Number</label>
                <input type="text" id="train-number" placeholder="e.g., 12345">
                
                <label for="train-type">Train Type</label>
                <select id="train-type">
                    <option value="express">Express</option>
                    <option value="passenger">Passenger</option>
                    <option value="freight">Freight</option>
                </select>
                
                <label for="train-priority">Priority</label>
                <select id="train-priority">
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
                
                <label for="train-direction">Direction</label>
                <select id="train-direction">
                    <option value="up">Up (Nadiad → Anand)</option>
                    <option value="down">Down (Anand → Nadiad)</option>
                </select>
                
                <button id="add-train-btn">Add Train</button>
            </div>
            
            <div class="form-group">
                <label for="section-select">Select Section/Junction</label>
                <select id="section-select">
                    <option value="nadiad-anand">Nadiad – Anand Section</option>
                    <option value="anand-vadodara">Anand – Vadodara Section</option>
                    <option value="ahmedabad-nadiad">Ahmedabad – Nadiad Section</option>
                </select>
            </div>
            
            <div class="action-buttons">
                <button class="btn-simulate" id="simulate-btn">Simulate Flow</button>
                <button class="btn-clear" id="clear-btn">Clear Data</button>
                <button class="btn-whatif" id="whatif-btn">What-if Scenario</button>
            </div>
            
            <!-- Train List -->
            <!-- Search and Filter -->
            <div class="form-group">
                <h3>Search & Filter</h3>
                <input type="text" id="train-search" placeholder="Search trains..." class="search-input">
                <div class="filter-options">
                    <label><input type="checkbox" id="filter-express" checked> Express</label>
                    <label><input type="checkbox" id="filter-passenger" checked> Passenger</label>
                    <label><input type="checkbox" id="filter-freight" checked> Freight</label>
                </div>
                <div class="filter-options">
                    <label><input type="checkbox" id="filter-running" checked> Running</label>
                    <label><input type="checkbox" id="filter-waiting" checked> Waiting</label>
                    <label><input type="checkbox" id="filter-halted" checked> Halted</label>
                </div>
            </div>
            
            <div class="train-list">
                <h3>Trains in Section</h3>
                <div id="trains-container">
                    <!-- Train cards will be added here dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Main Area -->
        <div class="main-area">
            <!-- Top Bar -->
            <div class="top-bar">
                <div>
                    <h2 class="section-name" id="current-section">Nadiad – Anand Section</h2>
                    <div class="datetime" id="datetime-display">Loading date and time...</div>
                </div>
                <div class="top-bar-actions">
                    <button id="refresh-btn">Refresh</button>
                    <button id="settings-btn">Settings</button>
                </div>
            </div>
            
            <!-- Visualization Canvas -->
            <div class="visualization">
                <div class="visualization-header">
                    <h3>Track Visualization</h3>
                    <div class="visualization-controls">
                        <button id="zoom-in-btn" title="Zoom In">+</button>
                        <button id="zoom-out-btn" title="Zoom Out">-</button>
                        <button id="reset-view-btn" title="Reset View">↺</button>
                    </div>
                </div>
                <svg class="track-diagram" id="track-diagram">
                    <!-- SVG track diagram will be generated here -->
                </svg>
                <div id="trains-visualization">
                    <!-- Train elements will be added here dynamically -->
                </div>
                <div class="track-legend">
                    <div class="legend-item"><span class="legend-color express"></span>Express</div>
                    <div class="legend-item"><span class="legend-color passenger"></span>Passenger</div>
                    <div class="legend-item"><span class="legend-color freight"></span>Freight</div>
                </div>
            </div>
            
            <!-- Panels -->
            <div class="panels">
                <!-- KPIs Dashboard -->
                <div class="panel">
                    <h3 class="panel-title">Key Performance Indicators</h3>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-throughput">12</div>
                            <div class="kpi-label">Trains/Hour</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-delay">8.5</div>
                            <div class="kpi-label">Avg. Delay (min)</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-utilization">78%</div>
                            <div class="kpi-label">Utilization</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-conflicts">3</div>
                            <div class="kpi-label">Active Conflicts</div>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendations Panel -->
                <div class="panel">
                    <h3 class="panel-title">AI Recommendations</h3>
                    <div id="recommendations-container">
                        <!-- Recommendation cards will be added here dynamically -->
                    </div>
                </div>
                
                <!-- Event Log -->
                <div class="panel">
                    <h3 class="panel-title">Event Log</h3>
                    <div id="event-log-container">
                        <!-- Log entries will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Train Popup -->
    <div class="train-popup" id="train-popup">
        <button class="close-popup" id="close-popup">×</button>
        <h3 id="popup-train-number">Train 12345</h3>
        <div class="train-popup-details" id="popup-train-details">
            <!-- Train details will be added here dynamically -->
        </div>
        <button id="popup-action-btn">Take Action</button>
    </div>
    
    <script>
        // Global variables
        let trains = [];
        let recommendations = [];
        let eventLog = [];
        let simulationRunning = false;
        let selectedTrain = null;
        
        // DOM Elements
        const trainNumberInput = document.getElementById('train-number');
        const trainTypeSelect = document.getElementById('train-type');
        const trainPrioritySelect = document.getElementById('train-priority');
        const trainDirectionSelect = document.getElementById('train-direction');
        const addTrainBtn = document.getElementById('add-train-btn');
        const sectionSelect = document.getElementById('section-select');
        const simulateBtn = document.getElementById('simulate-btn');
        const clearBtn = document.getElementById('clear-btn');
        const whatifBtn = document.getElementById('whatif-btn');
        const trainsContainer = document.getElementById('trains-container');
        const currentSectionDisplay = document.getElementById('current-section');
        const datetimeDisplay = document.getElementById('datetime-display');
        const refreshBtn = document.getElementById('refresh-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const trackDiagram = document.getElementById('track-diagram');
        const trainsVisualization = document.getElementById('trains-visualization');
        const kpiThroughput = document.getElementById('kpi-throughput');
        const kpiDelay = document.getElementById('kpi-delay');
        const kpiUtilization = document.getElementById('kpi-utilization');
        const kpiConflicts = document.getElementById('kpi-conflicts');
        const recommendationsContainer = document.getElementById('recommendations-container');
        const eventLogContainer = document.getElementById('event-log-container');
        const trainPopup = document.getElementById('train-popup');
        const closePopupBtn = document.getElementById('close-popup');
        const popupTrainNumber = document.getElementById('popup-train-number');
        const popupTrainDetails = document.getElementById('popup-train-details');
        const popupActionBtn = document.getElementById('popup-action-btn');
        
        // Initialize the application
        function init() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            drawTrackDiagram();
            loadDummyData();
            renderTrains();
            renderRecommendations();
            renderEventLog();
            setupEventListeners();
        }
        
        // Update date and time display
        function updateDateTime() {
            const now = new Date();
            datetimeDisplay.textContent = now.toLocaleString();
        }
        
        // Draw the track diagram using SVG
        function drawTrackDiagram() {
            // Set SVG viewBox
            trackDiagram.setAttribute('viewBox', '0 0 1000 200');
            
            // Draw secondary/loop tracks
            const loopTracks = [
                { d: 'M 100 80 L 300 80', station: 'Nadiad-Kanjari' },
                { d: 'M 500 80 L 700 80', station: 'Uttarsanda-Ode' },
                { d: 'M 100 120 L 300 120', station: 'Nadiad-Kanjari' },
                { d: 'M 700 120 L 900 120', station: 'Ode-Anand' }
            ];
            
            loopTracks.forEach(track => {
                const loopTrack = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                loopTrack.setAttribute('d', track.d);
                loopTrack.setAttribute('class', 'track-secondary');
                loopTrack.setAttribute('data-station', track.station);
                trackDiagram.appendChild(loopTrack);
            });
            
            // Draw main track line segments between each junction
            const junctionPositions = [100, 300, 500, 700, 900];
            
            // Create track segments between each junction
            for (let i = 0; i < junctionPositions.length - 1; i++) {
                const trackSegment = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                trackSegment.setAttribute('d', `M ${junctionPositions[i]} 100 L ${junctionPositions[i+1]} 100`);
                trackSegment.setAttribute('class', 'track');
                trackDiagram.appendChild(trackSegment);
            }
            
            // Add dotted secondary tracks between junctions
            for (let i = 0; i < junctionPositions.length - 1; i++) {
                if (i % 2 === 0) { // Add dotted lines for alternating segments
                    const dottedTrack = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    dottedTrack.setAttribute('d', `M ${junctionPositions[i]} 80 L ${junctionPositions[i+1]} 80`);
                    dottedTrack.setAttribute('class', 'track-secondary dotted');
                    trackDiagram.appendChild(dottedTrack);
                    
                    const dottedTrack2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    dottedTrack2.setAttribute('d', `M ${junctionPositions[i]} 120 L ${junctionPositions[i+1]} 120`);
                    dottedTrack2.setAttribute('class', 'track-secondary dotted');
                    trackDiagram.appendChild(dottedTrack2);
                }
            }
            
            // Connect loop tracks to main track
            const connections = [
                { d: 'M 100 100 C 100 80, 100 80, 120 80', type: 'main-to-loop' },
                { d: 'M 280 80 C 300 80, 300 80, 300 100', type: 'loop-to-main' },
                { d: 'M 500 100 C 500 80, 500 80, 520 80', type: 'main-to-loop' },
                { d: 'M 680 80 C 700 80, 700 80, 700 100', type: 'loop-to-main' },
                { d: 'M 100 100 C 100 120, 100 120, 120 120', type: 'main-to-loop' },
                { d: 'M 280 120 C 300 120, 300 120, 300 100', type: 'loop-to-main' },
                { d: 'M 700 100 C 700 120, 700 120, 720 120', type: 'main-to-loop' },
                { d: 'M 880 120 C 900 120, 900 120, 900 100', type: 'loop-to-main' }
            ];
            
            connections.forEach(conn => {
                const connection = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                connection.setAttribute('d', conn.d);
                connection.setAttribute('class', 'track-secondary');
                connection.setAttribute('data-type', conn.type);
                trackDiagram.appendChild(connection);
            });
            
            // Draw stations - swapped some junction positions
            const stations = [
                { name: 'Nadiad', x: 100, isJunction: true },
                { name: 'Kanjari', x: 300, isJunction: true }, // Changed to junction
                { name: 'Uttarsanda', x: 500, isJunction: false }, // Changed to regular station
                { name: 'Ode', x: 700, isJunction: true },
                { name: 'Anand', x: 900, isJunction: true }
            ];
            
            stations.forEach(station => {
                // Use circles with different styles for junctions instead of polygons
                if (station.isJunction) {
                    // Junction station - use a diamond shape with inner circle
                    const junctionOuter = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    junctionOuter.setAttribute('cx', station.x);
                    junctionOuter.setAttribute('cy', 100);
                    junctionOuter.setAttribute('r', 25);
                    junctionOuter.setAttribute('class', 'station junction-outer');
                    trackDiagram.appendChild(junctionOuter);
                    
                    const junctionInner = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    junctionInner.setAttribute('cx', station.x);
                    junctionInner.setAttribute('cy', 100);
                    junctionInner.setAttribute('r', 15);
                    junctionInner.setAttribute('class', 'station-inner');
                    trackDiagram.appendChild(junctionInner);
                    
                    // Add crossing lines to indicate junction
                    const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line1.setAttribute('x1', station.x - 15);
                    line1.setAttribute('y1', 85);
                    line1.setAttribute('x2', station.x + 15);
                    line1.setAttribute('y2', 115);
                    line1.setAttribute('class', 'junction-line');
                    trackDiagram.appendChild(line1);
                    
                    const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line2.setAttribute('x1', station.x - 15);
                    line2.setAttribute('y1', 115);
                    line2.setAttribute('x2', station.x + 15);
                    line2.setAttribute('y2', 85);
                    line2.setAttribute('class', 'junction-line');
                    trackDiagram.appendChild(line2);
                } else {
                    // Regular station - simple rectangle
                    const stationRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    stationRect.setAttribute('x', station.x - 30);
                    stationRect.setAttribute('y', 85);
                    stationRect.setAttribute('width', 60);
                    stationRect.setAttribute('height', 30);
                    stationRect.setAttribute('class', 'station');
                    stationRect.setAttribute('data-station', station.name);
                    trackDiagram.appendChild(stationRect);
                }
                
                // Station name
                const stationText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                stationText.setAttribute('x', station.x);
                stationText.setAttribute('y', 150);
                stationText.setAttribute('class', 'station-label');
                stationText.textContent = station.name;
                trackDiagram.appendChild(stationText);
                
                // Junction indicator if applicable
                if (station.isJunction) {
                    const junctionIndicator = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    junctionIndicator.setAttribute('x', station.x);
                    junctionIndicator.setAttribute('y', 165);
                    junctionIndicator.setAttribute('class', 'station-label');
                    junctionIndicator.setAttribute('font-size', '10');
                    junctionIndicator.textContent = '(Junction)';
                    trackDiagram.appendChild(junctionIndicator);
                }
            });
        }
        
        // Load dummy data for demonstration
        function loadDummyData() {
            // Dummy trains
            trains = [
                { id: 1, number: '12928', type: 'express', priority: 'high', direction: 'up', status: 'running', position: 150 },
                { id: 2, number: '19011', type: 'passenger', priority: 'medium', direction: 'down', status: 'waiting', position: 850 },
                { id: 3, number: '4321', type: 'freight', priority: 'low', direction: 'up', status: 'halted', position: 300 }
            ];
            
            // Dummy recommendations
            recommendations = [
                {
                    id: 1,
                    action: 'Hold Freight 4321 at Kanjari',
                    justification: 'To allow Express 12928 to pass, reducing overall delay by 12 minutes',
                    impact: 'High'
                },
                {
                    id: 2,
                    action: 'Reroute Passenger 19011 via Loop Line at Ode',
                    justification: 'To avoid conflict with upcoming Express 12952',
                    impact: 'Medium'
                }
            ];
            
            // Dummy event log
            eventLog = [
                { time: '10:15', message: 'Express 12928 departed from Nadiad', type: 'departure' },
                { time: '10:18', message: 'Freight 4321 halted at Kanjari', type: 'action' },
                { time: '10:22', message: 'Passenger 19011 waiting at Anand', type: 'status' }
            ];
        }
        
        // Render trains in the sidebar
        function renderTrains() {
            trainsContainer.innerHTML = '';
            
            if (trains.length === 0) {
                trainsContainer.innerHTML = '<p>No trains in the section.</p>';
                return;
            }
            
            trains.forEach(train => {
                const trainCard = document.createElement('div');
                trainCard.className = `train-card ${train.type} ${selectedTrain === train.id ? 'selected' : ''}`;
                trainCard.dataset.trainId = train.id;
                
                trainCard.innerHTML = `
                    <div class="train-card-header">
                        <div class="train-number">${train.number}</div>
                        <div class="priority-chip priority-${train.priority}">${train.priority}</div>
                    </div>
                    <div class="train-details">
                        <div class="train-type">
                            <span>${getTrainTypeIcon(train.type)}</span>
                            <span>${capitalizeFirstLetter(train.type)}</span>
                        </div>
                        <div class="train-status">${capitalizeFirstLetter(train.status)}</div>
                    </div>
                    <div class="train-card-drag-handle" title="Drag to reorder">
                        <div class="drag-handle-line"></div>
                        <div class="drag-handle-line"></div>
                        <div class="drag-handle-line"></div>
                    </div>
                `;
                
                trainCard.addEventListener('click', () => {
                    selectTrain(train.id);
                });
                
                // Add drag and drop functionality
                trainCard.setAttribute('draggable', true);
                
                trainCard.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', train.id);
                    trainCard.classList.add('dragging');
                    setTimeout(() => {
                        trainCard.style.opacity = '0.4';
                    }, 0);
                });
                
                trainCard.addEventListener('dragend', () => {
                    trainCard.classList.remove('dragging');
                    trainCard.style.opacity = '1';
                });
                
                trainsContainer.appendChild(trainCard);
            });
            
            // Add drop zone event listeners
            trainsContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggingCard = document.querySelector('.dragging');
                if (!draggingCard) return;
                
                const afterElement = getDragAfterElement(trainsContainer, e.clientY);
                if (afterElement) {
                    trainsContainer.insertBefore(draggingCard, afterElement);
                } else {
                    trainsContainer.appendChild(draggingCard);
                }
            });
            
            trainsContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const trainId = e.dataTransfer.getData('text/plain');
                const cards = Array.from(trainsContainer.querySelectorAll('.train-card'));
                
                // Update the trains array based on new order
                const newTrains = [];
                cards.forEach(card => {
                    const id = parseInt(card.dataset.trainId);
                    const train = trains.find(t => t.id === id);
                    if (train) newTrains.push(train);
                });
                
                trains = newTrains;
                
                // Update the visualization
                renderTrainsOnTrack();
            });
            
            // Also render trains on the visualization
            renderTrainsOnTrack();
        }
        
        // Helper function for drag and drop
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.train-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // Render trains on the track visualization
        function renderTrainsOnTrack() {
            trainsVisualization.innerHTML = '';
            
            trains.forEach(train => {
                const trainElement = document.createElement('div');
                trainElement.className = `train train-${train.type} ${selectedTrain === train.id ? 'selected' : ''}`;
                trainElement.dataset.trainId = train.id;
                trainElement.style.left = `${train.position}px`;
                trainElement.style.top = train.direction === 'up' ? '85px' : '95px';
                trainElement.textContent = train.number;
                
                // Add a tooltip with train details
                trainElement.title = `${capitalizeFirstLetter(train.type)} ${train.number} (${capitalizeFirstLetter(train.priority)})`;
                
                trainElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectTrain(train.id);
                    showTrainPopup(train, e.clientX, e.clientY);
                });
                
                // Add animation class based on status
                if (train.status === 'running') {
                    trainElement.classList.add('train-running');
                } else if (train.status === 'waiting') {
                    trainElement.classList.add('train-waiting');
                } else if (train.status === 'halted') {
                    trainElement.classList.add('train-halted');
                }
                
                trainsVisualization.appendChild(trainElement);
            });
        }
        
        // Render recommendations
        function renderRecommendations() {
            recommendationsContainer.innerHTML = '';
            
            if (recommendations.length === 0) {
                recommendationsContainer.innerHTML = '<p>No recommendations at this time.</p>';
                return;
            }
            
            recommendations.forEach(rec => {
                const recCard = document.createElement('div');
                recCard.className = 'recommendation-card';
                
                recCard.innerHTML = `
                    <div><strong>${rec.action}</strong></div>
                    <div>${rec.justification}</div>
                    <div class="recommendation-actions">
                        <button class="btn-accept" data-rec-id="${rec.id}">Accept</button>
                        <button class="btn-override" data-rec-id="${rec.id}">Override</button>
                    </div>
                `;
                
                recommendationsContainer.appendChild(recCard);
            });
            
            // Add event listeners to recommendation buttons
            document.querySelectorAll('.btn-accept, .btn-override').forEach(btn => {
                btn.addEventListener('click', handleRecommendationAction);
            });
        }
        
        // Render event log
        function renderEventLog() {
            eventLogContainer.innerHTML = '';
            
            if (eventLog.length === 0) {
                eventLogContainer.innerHTML = '<p>No events recorded.</p>';
                return;
            }
            
            eventLog.forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                logEntry.innerHTML = `
                    <div class="log-time">${entry.time}</div>
                    <div class="log-message">${entry.message}</div>
                `;
                
                eventLogContainer.appendChild(logEntry);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Add train button
            addTrainBtn.addEventListener('click', addTrain);
            
            // Section select
            sectionSelect.addEventListener('change', changeSection);
            
            // Action buttons
            simulateBtn.addEventListener('click', simulateFlow);
            clearBtn.addEventListener('click', clearData);
            whatifBtn.addEventListener('click', startWhatIfScenario);
            
            // Top bar buttons
            refreshBtn.addEventListener('click', refreshData);
            settingsBtn.addEventListener('click', openSettings);
            
            // Popup close button
            closePopupBtn.addEventListener('click', hideTrainPopup);
            
            // Click outside popup to close
            document.addEventListener('click', (e) => {
                if (!trainPopup.contains(e.target) && e.target.className !== 'train') {
                    hideTrainPopup();
                }
            });
            
            // Add zoom functionality
            document.getElementById('zoom-in-btn').addEventListener('click', zoomIn);
            document.getElementById('zoom-out-btn').addEventListener('click', zoomOut);
            document.getElementById('reset-view-btn').addEventListener('click', resetView);
            
            // Search and filter functionality
            document.getElementById('train-search').addEventListener('input', applyFilters);
            
            // Type filter checkboxes
            document.getElementById('filter-express').addEventListener('change', applyFilters);
            document.getElementById('filter-passenger').addEventListener('change', applyFilters);
            document.getElementById('filter-freight').addEventListener('change', applyFilters);
            
            // Status filter checkboxes
            document.getElementById('filter-running').addEventListener('change', applyFilters);
            document.getElementById('filter-waiting').addEventListener('change', applyFilters);
            document.getElementById('filter-halted').addEventListener('change', applyFilters);
        }
        
        // Apply search and filters
        function applyFilters() {
            const searchTerm = document.getElementById('train-search').value.toLowerCase();
            
            // Type filters
            const showExpress = document.getElementById('filter-express').checked;
            const showPassenger = document.getElementById('filter-passenger').checked;
            const showFreight = document.getElementById('filter-freight').checked;
            
            // Status filters
            const showRunning = document.getElementById('filter-running').checked;
            const showWaiting = document.getElementById('filter-waiting').checked;
            const showHalted = document.getElementById('filter-halted').checked;
            
            // Get all train cards
            const trainCards = document.querySelectorAll('.train-card');
            
            trainCards.forEach(card => {
                const trainNumber = card.querySelector('.train-number').textContent.toLowerCase();
                const trainType = card.classList.contains('express') ? 'express' : 
                                 card.classList.contains('passenger') ? 'passenger' : 'freight';
                const trainStatus = card.getAttribute('data-status') || 'running';
                
                // Check if train matches all filters
                const matchesSearch = trainNumber.includes(searchTerm);
                const matchesType = (trainType === 'express' && showExpress) || 
                                   (trainType === 'passenger' && showPassenger) || 
                                   (trainType === 'freight' && showFreight);
                const matchesStatus = (trainStatus === 'running' && showRunning) || 
                                     (trainStatus === 'waiting' && showWaiting) || 
                                     (trainStatus === 'halted' && showHalted);
                
                // Show or hide based on filter results
                if (matchesSearch && matchesType && matchesStatus) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Track diagram zoom variables
        let currentZoom = 1;
        const zoomStep = 0.1;
        const maxZoom = 2;
        const minZoom = 0.5;
        
        // Zoom in function
        function zoomIn() {
            if (currentZoom < maxZoom) {
                currentZoom += zoomStep;
                applyZoom();
            }
        }
        
        // Zoom out function
        function zoomOut() {
            if (currentZoom > minZoom) {
                currentZoom -= zoomStep;
                applyZoom();
            }
        }
        
        // Reset view function
        function resetView() {
            currentZoom = 1;
            applyZoom();
        }
        
        // Apply zoom to track diagram
        function applyZoom() {
            trackDiagram.style.transform = `scale(${currentZoom})`;
            trackDiagram.style.transformOrigin = 'center center';
        }
        
        // Add a new train
        function addTrain() {
            const number = trainNumberInput.value.trim();
            const type = trainTypeSelect.value;
            const priority = trainPrioritySelect.value;
            const direction = trainDirectionSelect.value;
            
            if (!number) {
                alert('Please enter a train number');
                return;
            }
            
            const newTrain = {
                id: Date.now(),
                number,
                type,
                priority,
                direction,
                status: 'waiting',
                position: direction === 'up' ? 100 : 900
            };
            
            trains.push(newTrain);
            
            // Add to event log
            addEventLog(`Train ${number} added to the section`);
            
            // Clear form
            trainNumberInput.value = '';
            
            // Update UI
            renderTrains();
            updateKPIs();
        }
        
        // Change the current section
        function changeSection() {
            const sectionName = sectionSelect.options[sectionSelect.selectedIndex].text;
            currentSectionDisplay.textContent = sectionName;
            
            // In a real app, this would load data for the selected section
            // For this demo, we'll just update the UI
            refreshData();
        }
        
        // Simulate train flow
        function simulateFlow() {
            if (simulationRunning) {
                return;
            }
            
            simulationRunning = true;
            simulateBtn.textContent = 'Simulating...';
            
            // Generate new recommendations based on current trains
            generateRecommendations();
            
            // Move trains along the track
            const movementInterval = setInterval(() => {
                let allTrainsFinished = true;
                
                trains.forEach(train => {
                    if (train.status === 'running') {
                        // Move trains based on direction and type
                        const speed = getTrainSpeed(train.type);
                        
                        if (train.direction === 'up') {
                            train.position += speed;
                            if (train.position >= 900) {
                                train.status = 'completed';
                                addEventLog(`Train ${train.number} arrived at Anand`);
                            } else if (train.position >= 500 && Math.random() < 0.2) {
                                // Random events during simulation
                                train.status = 'halted';
                                addEventLog(`Train ${train.number} halted at Uttarsanda`);
                            }
                        } else {
                            train.position -= speed;
                            if (train.position <= 100) {
                                train.status = 'completed';
                                addEventLog(`Train ${train.number} arrived at Nadiad`);
                            } else if (train.position <= 500 && Math.random() < 0.2) {
                                train.status = 'halted';
                                addEventLog(`Train ${train.number} halted at Uttarsanda`);
                            }
                        }
                    } else if (train.status === 'waiting' && Math.random() < 0.3) {
                        // Randomly start waiting trains
                        train.status = 'running';
                        addEventLog(`Train ${train.number} started running`);
                    } else if (train.status === 'halted' && Math.random() < 0.2) {
                        // Randomly resume halted trains
                        train.status = 'running';
                        addEventLog(`Train ${train.number} resumed journey`);
                    }
                    
                    if (train.status !== 'completed') {
                        allTrainsFinished = false;
                    }
                });
                
                // Update UI
                renderTrains();
                updateKPIs();
                
                // End simulation if all trains have completed or after 30 seconds
                if (allTrainsFinished) {
                    clearInterval(movementInterval);
                    simulationRunning = false;
                    simulateBtn.textContent = 'Simulate Flow';
                    addEventLog('Simulation completed');
                }
            }, 1000);
            
            // Safety timeout to end simulation after 30 seconds
            setTimeout(() => {
                if (simulationRunning) {
                    clearInterval(movementInterval);
                    simulationRunning = false;
                    simulateBtn.textContent = 'Simulate Flow';
                    addEventLog('Simulation timeout reached');
                }
            }, 30000);
        }
        
        // Clear all data
        function clearData() {
            if (confirm('Are you sure you want to clear all data?')) {
                trains = [];
                recommendations = [];
                eventLog = [];
                selectedTrain = null;
                
                renderTrains();
                renderRecommendations();
                renderEventLog();
                updateKPIs();
                
                addEventLog('All data cleared');
            }
        }
        
        // Start a what-if scenario
        function startWhatIfScenario() {
            alert('What-if Scenario feature would allow you to test different decision strategies without affecting the real system. This feature is not implemented in this prototype.');
        }
        
        // Refresh data
        function refreshData() {
            // In a real app, this would fetch fresh data from the server
            // For this demo, we'll just update the UI
            renderTrains();
            renderRecommendations();
            renderEventLog();
            updateKPIs();
            
            addEventLog('Data refreshed');
        }
        
        // Open settings
        function openSettings() {
            alert('Settings panel would allow you to configure visualization preferences, alerts, and system parameters. This feature is not implemented in this prototype.');
        }
        
        // Select a train
        function selectTrain(trainId) {
            selectedTrain = trainId;
            renderTrains();
        }
        
        // Show train popup
        function showTrainPopup(train, x, y) {
            popupTrainNumber.textContent = `Train ${train.number}`;
            
            popupTrainDetails.innerHTML = `
                <p><strong>Type:</strong> ${capitalizeFirstLetter(train.type)}</p>
                <p><strong>Priority:</strong> ${capitalizeFirstLetter(train.priority)}</p>
                <p><strong>Direction:</strong> ${train.direction === 'up' ? 'Up (Nadiad → Anand)' : 'Down (Anand → Nadiad)'}</p>
                <p><strong>Status:</strong> ${capitalizeFirstLetter(train.status)}</p>
                <p><strong>Current Location:</strong> ${getTrainLocation(train.position)}</p>
            `;
            
            // Position the popup
            trainPopup.style.left = `${x}px`;
            trainPopup.style.top = `${y}px`;
            trainPopup.style.display = 'block';
        }
        
        // Hide train popup
        function hideTrainPopup() {
            trainPopup.style.display = 'none';
        }
        
        // Handle recommendation actions (accept/override)
        function handleRecommendationAction(e) {
            const recId = parseInt(e.target.dataset.recId);
            const action = e.target.classList.contains('btn-accept') ? 'accepted' : 'overridden';
            
            const recommendation = recommendations.find(r => r.id === recId);
            if (recommendation) {
                addEventLog(`Recommendation "${recommendation.action}" ${action}`);
                
                // Remove the recommendation
                recommendations = recommendations.filter(r => r.id !== recId);
                renderRecommendations();
                
                // If accepted, apply the recommendation effect
                if (action === 'accepted') {
                    applyRecommendationEffect(recommendation);
                }
            }
        }
        
        // Apply the effect of accepting a recommendation
        function applyRecommendationEffect(recommendation) {
            // This is a simplified implementation
            // In a real system, this would have more complex logic
            
            if (recommendation.action.includes('Hold')) {
                // Extract train number from recommendation
                const trainNumber = recommendation.action.match(/\d+/)[0];
                const train = trains.find(t => t.number === trainNumber);
                
                if (train) {
                    train.status = 'halted';
                    renderTrains();
                }
            } else if (recommendation.action.includes('Reroute')) {
                // Simulate rerouting by changing train position
                const trainNumber = recommendation.action.match(/\d+/)[0];
                const train = trains.find(t => t.number === trainNumber);
                
                if (train) {
                    // Adjust position to simulate rerouting
                    if (train.direction === 'up') {
                        train.position += 50;
                    } else {
                        train.position -= 50;
                    }
                    renderTrains();
                }
            }
            
            // Update KPIs to reflect the impact of the recommendation
            updateKPIs(true);
        }
        
        // Generate new recommendations based on current train situation
        function generateRecommendations() {
            // This is a simplified implementation
            // In a real system, this would use AI algorithms to generate recommendations
            
            // Clear existing recommendations
            recommendations = [];
            
            // Find potential conflicts between trains
            const runningTrains = trains.filter(t => t.status === 'running');
            const waitingTrains = trains.filter(t => t.status === 'waiting');
            const haltedTrains = trains.filter(t => t.status === 'halted');
            
            // Generate recommendations for running trains
            runningTrains.forEach(train => {
                // Check for potential conflicts with other running trains
                const conflictingTrains = runningTrains.filter(t => 
                    t.id !== train.id && 
                    Math.abs(t.position - train.position) < 200 &&
                    ((t.direction === 'up' && train.direction === 'down') || 
                     (t.priority > train.priority))
                );
                
                if (conflictingTrains.length > 0) {
                    const conflictTrain = conflictingTrains[0];
                    
                    if (train.priority === 'low' && conflictTrain.priority === 'high') {
                        recommendations.push({
                            id: Date.now() + Math.floor(Math.random() * 1000),
                            action: `Hold Freight ${train.number} at ${getTrainLocation(train.position)}`,
                            justification: `To allow Express ${conflictTrain.number} to pass, reducing overall delay by ${Math.floor(Math.random() * 15) + 5} minutes`,
                            impact: 'High'
                        });
                    }
                }
            });
            
            // Generate recommendations for waiting trains
            waitingTrains.forEach(train => {
                if (train.priority === 'high') {
                    recommendations.push({
                        id: Date.now() + Math.floor(Math.random() * 1000),
                        action: `Prioritize departure for Express ${train.number} from ${getTrainLocation(train.position)}`,
                        justification: 'High priority train with 120+ passengers waiting',
                        impact: 'Medium'
                    });
                }
            });
            
            // Generate recommendations for halted trains
            haltedTrains.forEach(train => {
                recommendations.push({
                    id: Date.now() + Math.floor(Math.random() * 1000),
                    action: `Resume journey for ${capitalizeFirstLetter(train.type)} ${train.number} at ${getTrainLocation(train.position)}`,
                    justification: `Track ahead is clear for the next ${Math.floor(Math.random() * 10) + 5} km`,
                    impact: 'Medium'
                });
            });
            
            // Update UI
            renderRecommendations();
        }
        
        // Add an entry to the event log
        function addEventLog(message) {
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            eventLog.unshift({
                time,
                message,
                type: 'status'
            });
            
            // Keep log at a reasonable size
            if (eventLog.length > 20) {
                eventLog.pop();
            }
            
            renderEventLog();
        }
        
        // Update KPIs
        function updateKPIs(improved = false) {
            // In a real system, these would be calculated based on actual data
            // For this demo, we'll use random values with some logic
            
            const runningTrains = trains.filter(t => t.status === 'running').length;
            const totalTrains = trains.length;
            
            // Calculate throughput (trains per hour)
            let throughput = Math.floor(Math.random() * 5) + 10;
            if (improved) throughput += 2;
            
            // Calculate average delay
            let avgDelay = Math.floor(Math.random() * 10) + 5;
            if (improved) avgDelay -= 2;
            if (avgDelay < 0) avgDelay = 0;
            
            // Calculate utilization
            let utilization = totalTrains > 0 ? Math.floor((runningTrains / totalTrains) * 100) : 0;
            if (improved) utilization += 5;
            if (utilization > 100) utilization = 100;
            
            // Calculate conflicts
            let conflicts = Math.floor(Math.random() * 5);
            if (improved) conflicts -= 1;
            if (conflicts < 0) conflicts = 0;
            
            // Update the UI
            kpiThroughput.textContent = throughput;
            kpiDelay.textContent = avgDelay;
            kpiUtilization.textContent = `${utilization}%`;
            kpiConflicts.textContent = conflicts;
        }
        
        // Helper function to get train type icon
        function getTrainTypeIcon(type) {
            switch (type) {
                case 'express':
                    return '🚄';
                case 'passenger':
                    return '🚆';
                case 'freight':
                    return '🚂';
                default:
                    return '🚆';
            }
        }
        
        // Helper function to get train speed based on type
        function getTrainSpeed(type) {
            switch (type) {
                case 'express':
                    return 15;
                case 'passenger':
                    return 10;
                case 'freight':
                    return 5;
                default:
                    return 10;
            }
        }
        
        // Helper function to get train location based on position
        function getTrainLocation(position) {
            if (position <= 200) return 'Nadiad';
            if (position <= 400) return 'Kanjari';
            if (position <= 600) return 'Uttarsanda';
            if (position <= 800) return 'Ode';
            return 'Anand';
        }
        
        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Initialize the application when the page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>